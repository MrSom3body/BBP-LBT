- name: Ensure AD Sites exist
  loop: "{{ ad_sites }}"
  loop_control:
    label: "{{ item.name }}"
  ansible.windows.win_powershell:
    error_action: stop
    parameters:
      SiteName: "{{ item.name }}"
    script: |
      param([string]$SiteName)

      $changeOccurred = $false

      if (-not (Get-ADReplicationSite -Filter {Name -eq $SiteName})) {
        New-ADReplicationSite -Name $SiteName
        $changeOccurred = $true
      }

      $Ansible.Changed = $changeOccurred

- name: Ensure Subnets are assigned to AD Sites
  loop: "{{ ad_sites }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.subnets is defined and (item.subnets | length > 0)
  ansible.windows.win_powershell:
    error_action: stop
    parameters:
      SiteName: "{{ item.name }}"
      Subnets: "{{ item.subnets }}"
    script: |
      param(
        [string]$SiteName,
        [string[]]$Subnets
      )

      $changeOccurred = $false

      foreach ($cidr in $Subnets) {
        $subnetObj = Get-ADReplicationSubnet -Filter {Name -eq $cidr} -Properties Site

        if (-not $subnetObj) {
          New-ADReplicationSubnet -Name $cidr -Site $SiteName
          $changeOccurred = $true
          continue
        }

        $currentSiteName = ""
        if ($subnetObj.Site) {
          $currentSiteName = ($subnetObj.Site -split ",")[0] -replace "CN=",""
        }

        if ($currentSiteName -ne $SiteName) {
          Set-ADReplicationSubnet -Identity $cidr -Site $SiteName
          $changeOccurred = $true
        }
      }

      $Ansible.Changed = $changeOccurred

- name: Ensure Domain Controllers are in the correct AD Sites
  loop: "{{ ad_sites }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.dcs is defined and (item.dcs | length > 0)
  ansible.windows.win_powershell:
    error_action: stop
    parameters:
      SiteName: "{{ item.name }}"
      DomainControllers: "{{ item.dcs }}"
    script: |
      param(
        [string]$SiteName,
        [string[]]$DomainControllers
      )

      $changeOccurred = $false

      foreach ($dcName in $DomainControllers) {
        try {
            $dcObj = Get-ADDomainController -Identity $dcName -ErrorAction Stop
        } catch {
            Write-Warning "DC '$dcName' not found."
            continue
        }

        if ($dcObj.Site -ne $SiteName) {
            Move-ADDirectoryServer -Identity $dcName -Site $SiteName
            $changeOccurred = $true
        }
      }

      $Ansible.Changed = $changeOccurred
